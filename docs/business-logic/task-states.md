# Bug 119 任務狀態管理系統分析與設計方案

## 業務邏輯分析

### 任務狀態流程

任務在系統中經歷以下五個主要狀態：

1. **PENDING (發布中)** → 初始狀態，任務剛被小怕星建立，終結者可以申請任務
2. **PENDING_CONFIRMATION (待確認)** → 有終結者申請後進入此狀態，小怕星可以選擇終結者
3. **IN_PROGRESS (進行中)** → 小怕星選擇終結者後進入此狀態，雙方都可以確認任務完成
4. **PENDING_COMPLETION (待完成確認)** → 一方確認完成後進入此狀態，等待另一方也確認完成
5. **COMPLETED (已完成)** → 雙方都確認完成後的最終狀態，任務正式結束

### 狀態轉換規則

```
PENDING → PENDING_CONFIRMATION
條件: 至少一位終結者申請任務

PENDING_CONFIRMATION → IN_PROGRESS
條件: 小怕星選擇委託對象

IN_PROGRESS → PENDING_COMPLETION
條件: 任一方確認任務完成

PENDING_COMPLETION → COMPLETED
條件: 另一方也確認任務完成
```

## 各角色在不同狀態的權限與顯示內容

### PENDING 狀態 (發布中)

#### 小怕星 (任務發布者)
- **可見內容**: 看到自己發布的任務詳情
- **權限**: 等待終結者申請
- **操作**: 無需操作，等待申請
- **顯示資訊**: 
  - 任務基本資訊
  - 申請者數量 (0)
  - 任務狀態指示器

#### 終結者 (任務接受者)
- **可見內容**: 看到所有可申請的任務列表
- **權限**: 可點擊「接受任務」申請
- **操作**: 申請任務
- **顯示資訊**: 
  - 任務基本資訊
  - 小怕星的基本資料（不含聯絡方式）
  - 預算範圍
  - 任務地點

### PENDING_CONFIRMATION 狀態 (待確認)

#### 小怕星 (任務發布者)
- **可見內容**: 看到所有申請者的詳細資料
- **權限**: 可選擇委託對象
- **操作**: 選擇終結者並確認委託
- **顯示資訊**: 
  - 所有申請者的完整個人資料
  - 申請時間

#### 終結者 (任務接受者)
- **可見內容**: 只能看到小怕星的基本資訊
- **權限**: 等待被選中
- **操作**: 等待結果
- **顯示資訊**: 
  - 申請狀態
  - 小怕星基本資料（不含聯絡方式）
  - 任務詳情

### IN_PROGRESS 狀態 (進行中)

#### 雙方 (小怕星 & 終結者)
- **可見內容**: 都能看到對方的完整聯絡資訊
- **權限**: 都有「完成任務」按鈕
- **操作**: 
  - 確認任務完成
- **顯示資訊**: 
  - 對方完整聯絡資訊
  - 任務進度狀態
  - 任務詳細資訊

### PENDING_COMPLETION 狀態 (待完成確認)

#### 已確認方
- **可見內容**: 任務狀態顯示為「已確認完成」
- **權限**: 等待對方確認
- **操作**: 無需操作
- **顯示資訊**: 
  - 等待對方確認的提示
  - 任務基本資訊

#### 未確認方
- **可見內容**: 看到對方已確認，需要自己確認
- **權限**: 可確認任務完成
- **操作**: 點擊「確認完成」
- **顯示資訊**: 
  - 對方已確認的提示
  - 「確認完成」按鈕

### COMPLETED 狀態 (已完成)

#### 雙方 (小怕星 & 終結者)
- **可見內容**: 任務基本資訊，聯絡資訊隱藏
- **權限**: 任務正式結束
- **操作**: 無需操作
- **顯示資訊**: 
  - 任務完成時間
  - 任務基本資訊
  - 完成狀態標示

## 資訊可見性矩陣

| 狀態 | 小怕星可見 | 終結者可見 | 備註 |
|------|------------|------------|------|
| PENDING | 自己的任務詳情 | 所有可申請任務 | 終結者無法看到聯絡資訊 |
| PENDING_CONFIRMATION | 所有申請者完整資料 | 小怕星基本資料 | 小怕星選擇階段 |
| IN_PROGRESS | 對方完整聯絡資訊 | 對方完整聯絡資訊 | 雙方可完全聯繫 |
| PENDING_COMPLETION | 等待確認狀態 | 等待確認狀態 | 顯示確認進度 |
| COMPLETED | 任務基本資訊 | 任務基本資訊 | 聯絡資訊隱藏，任務結束 |

## 通知機制

### 狀態變更通知

1. **PENDING → PENDING_CONFIRMATION**
   - 小怕星: 「您的任務收到新的申請」
   - 終結者: 「您已成功申請任務」

2. **PENDING_CONFIRMATION → IN_PROGRESS**
   - 選中的終結者: 「恭喜！您被選中執行任務」
   - 小怕星: 「您已成功委託任務」

3. **IN_PROGRESS → PENDING_COMPLETION**
   - 確認方: 「您已確認任務完成」
   - 未確認方: 「對方已確認完成，請您也確認」

4. **PENDING_COMPLETION → COMPLETED**
   - 雙方: 「任務已完成」


## 安全性考量

### 聯絡資訊保護
- 只有在 IN_PROGRESS 狀態下才能看到完整聯絡資訊
- 任務完成後自動隱藏聯絡資訊
- 防止資訊洩露和騷擾

### 任務完成驗證
- 雙方確認機制防止單方面完成
- 任務進度追蹤確保真實性


## 異常情況處理

### 系統簡化設計
- 任務流程簡化為 5 個核心狀態
- 移除取消、刪除等複雜操作
- 專注於核心任務完成流程

### 異常處理
- 系統不提供客服功能
- 記錄所有操作日誌
- 任務問題由雙方自行協調解決

### 超時處理
- 系統不設置超時機制
- 任務狀態變更完全由用戶操作驅動
- 專注於簡潔的用戶體驗

## 資料結構設計

### 任務狀態列舉
```typescript
export enum TaskStatus {
  PENDING = 'PENDING',
  PENDING_CONFIRMATION = 'PENDING_CONFIRMATION',
  IN_PROGRESS = 'IN_PROGRESS',
  PENDING_COMPLETION = 'PENDING_COMPLETION',
  COMPLETED = 'COMPLETED'
}
```

### 任務申請狀態
```typescript
export enum ApplicationStatus {
  PENDING = 'PENDING',
  ACCEPTED = 'ACCEPTED',
  REJECTED = 'REJECTED'
}
```

### 完成確認狀態
```typescript
export enum CompletionStatus {
  NONE = 'NONE',
  FEAR_STAR_CONFIRMED = 'FEAR_STAR_CONFIRMED',
  TERMINATOR_CONFIRMED = 'TERMINATOR_CONFIRMED',
  BOTH_CONFIRMED = 'BOTH_CONFIRMED'
}
```

## 詳細操作權限

### 小怕星操作權限
- **PENDING 狀態**: 
  - 等待終結者申請
- **PENDING_CONFIRMATION 狀態**: 
  - 可選擇終結者
- **IN_PROGRESS 狀態**: 
  - 可確認任務完成
- **PENDING_COMPLETION 狀態**: 
  - 等待對方確認或自己確認（取決於誰先確認）
- **COMPLETED 狀態**: 
  - 任務結束，無需操作

### 終結者操作權限
- **PENDING 狀態**: 
  - 可申請任務
- **PENDING_CONFIRMATION 狀態**: 
  - 等待被選中
- **IN_PROGRESS 狀態**: 
  - 可確認任務完成
- **PENDING_COMPLETION 狀態**: 
  - 等待對方確認或自己確認（取決於誰先確認）
- **COMPLETED 狀態**: 
  - 任務結束，無需操作

## 實作建議

### 前端狀態管理
- 使用 Redux 管理任務狀態
- 實作狀態轉換中介軟體
- 前端路由權限控制

### 後端 API 設計
- RESTful API 設計
- 狀態轉換 API 端點
- 權限驗證中介軟體


這份文件提供了 Bug 119 任務狀態管理系統的完整分析與設計方案，可作為開發團隊的重要參考文件。