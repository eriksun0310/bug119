# Bug 119 任務狀態管理系統分析與設計方案

## 業務邏輯分析

### 任務狀態流程

任務在系統中經歷以下四個主要狀態：

1. **PENDING (發布中)** → 終結者可申請
2. **PENDING_CONFIRMATION (待確認)** → 小怕星選擇終結者
3. **IN_PROGRESS (進行中)** → 雙方協作完成任務
4. **COMPLETED (已完成)** → 任務結束

### 狀態轉換規則

```
PENDING → PENDING_CONFIRMATION
條件: 至少一位終結者申請任務

PENDING_CONFIRMATION → IN_PROGRESS
條件: 小怕星選擇委託對象

IN_PROGRESS → COMPLETED
條件: 雙方都確認任務完成
```

## 各角色在不同狀態的權限與顯示內容

### PENDING 狀態 (發布中)

#### 小怕星 (任務發布者)
- **可見內容**: 看到自己發布的任務詳情
- **權限**: 等待終結者申請
- **操作**: 可編輯或刪除任務
- **顯示資訊**: 
  - 任務基本資訊
  - 申請者數量 (0)
  - 任務狀態指示器

#### 終結者 (任務接受者)
- **可見內容**: 看到所有可申請的任務列表
- **權限**: 可點擊「接受任務」申請
- **操作**: 申請任務
- **顯示資訊**: 
  - 任務基本資訊
  - 小怕星的基本資料（不含聯絡方式）
  - 預算範圍
  - 任務地點

### PENDING_CONFIRMATION 狀態 (待確認)

#### 小怕星 (任務發布者)
- **可見內容**: 看到所有申請者的詳細資料
- **權限**: 可選擇委託對象
- **操作**: 選擇終結者並確認委託
- **顯示資訊**: 
  - 所有申請者的完整個人資料
  - 申請者的服務記錄
  - 評價和評分
  - 申請時間

#### 終結者 (任務接受者)
- **可見內容**: 只能看到小怕星的基本資訊
- **權限**: 等待被選中
- **操作**: 可撤回申請
- **顯示資訊**: 
  - 申請狀態
  - 小怕星基本資料（不含聯絡方式）
  - 任務詳情

### IN_PROGRESS 狀態 (進行中)

#### 雙方 (小怕星 & 終結者)
- **可見內容**: 都能看到對方的完整聯絡資訊
- **權限**: 都有「完成任務」按鈕
- **操作**: 
  - 確認任務完成
  - 即時聊天溝通
  - 上傳任務進度照片
- **顯示資訊**: 
  - 對方完整聯絡資訊
  - 任務進度狀態
  - 聊天記錄
  - 任務詳細資訊

#### 完成機制
- **雙方確認**: 需要雙方都點擊「完成任務」才能進入 COMPLETED 狀態
- **單方確認**: 若只有一方確認，系統顯示「等待對方確認」
- **爭議處理**: 若有爭議，可聯繫客服介入

### COMPLETED 狀態 (已完成)

#### 雙方 (小怕星 & 終結者)
- **可見內容**: 聯絡資訊隱藏，只保留任務基本資訊
- **權限**: 可進行評價和評分
- **操作**: 
  - 對對方進行評價
  - 查看任務歷史記錄
- **顯示資訊**: 
  - 任務完成時間
  - 任務基本資訊
  - 雙方評價 (完成後)
  - 任務成果照片

## 資訊可見性矩陣

| 狀態 | 小怕星可見 | 終結者可見 | 備註 |
|------|------------|------------|------|
| PENDING | 自己的任務詳情 | 所有可申請任務 | 終結者無法看到聯絡資訊 |
| PENDING_CONFIRMATION | 所有申請者完整資料 | 小怕星基本資料 | 小怕星選擇階段 |
| IN_PROGRESS | 對方完整聯絡資訊 | 對方完整聯絡資訊 | 雙方可完全聯繫 |
| COMPLETED | 基本資訊 + 評價 | 基本資訊 + 評價 | 聯絡資訊隱藏 |

## 通知機制

### 狀態變更通知

1. **PENDING → PENDING_CONFIRMATION**
   - 小怕星: 「您的任務收到新的申請」
   - 終結者: 「您已成功申請任務」

2. **PENDING_CONFIRMATION → IN_PROGRESS**
   - 選中的終結者: 「恭喜！您被選中執行任務」
   - 未選中的終結者: 「很遺憾，此次任務您未被選中」
   - 小怕星: 「您已成功委託任務」

3. **IN_PROGRESS → COMPLETED**
   - 雙方: 「任務已完成，請進行評價」

### 即時通訊通知

- **IN_PROGRESS 狀態**: 新訊息推送通知
- **進度更新**: 任務進度變更通知
- **完成確認**: 對方確認完成任務通知

## 安全性考量

### 聯絡資訊保護
- 只有在 IN_PROGRESS 狀態下才能看到完整聯絡資訊
- 任務完成後自動隱藏聯絡資訊
- 防止資訊洩露和騷擾

### 任務完成驗證
- 雙方確認機制防止單方面完成
- 任務進度追蹤確保真實性
- 照片上傳作為完成證明

### 評價系統
- 完成任務後才能評價
- 雙向評價機制
- 評價內容審核機制

## 異常情況處理

### 任務取消
- **PENDING 狀態**: 小怕星可直接取消
- **PENDING_CONFIRMATION 狀態**: 小怕星可取消，需通知已申請的終結者
- **IN_PROGRESS 狀態**: 需要客服介入處理

### 爭議處理
- 提供客服聯繫機制
- 記錄所有操作日誌
- 支援申訴和仲裁流程

### 超時處理
- 申請超時自動取消
- 任務執行超時預警
- 長時間未完成任務的處理機制

## 資料結構設計

### 任務狀態列舉
```typescript
export enum TaskStatus {
  PENDING = 'PENDING',
  PENDING_CONFIRMATION = 'PENDING_CONFIRMATION',
  IN_PROGRESS = 'IN_PROGRESS',
  COMPLETED = 'COMPLETED'
}
```

### 任務申請狀態
```typescript
export enum ApplicationStatus {
  PENDING = 'PENDING',
  ACCEPTED = 'ACCEPTED',
  REJECTED = 'REJECTED'
}
```

### 完成確認狀態
```typescript
export enum CompletionStatus {
  NONE = 'NONE',
  FEAR_STAR_CONFIRMED = 'FEAR_STAR_CONFIRMED',
  TERMINATOR_CONFIRMED = 'TERMINATOR_CONFIRMED',
  BOTH_CONFIRMED = 'BOTH_CONFIRMED'
}
```

## 實作建議

### 前端狀態管理
- 使用 Redux 管理任務狀態
- 實作狀態轉換中介軟體
- 前端路由權限控制

### 後端 API 設計
- RESTful API 設計
- 狀態轉換 API 端點
- 權限驗證中介軟體

### 即時通訊
- WebSocket 連線管理
- 房間管理機制
- 訊息持久化

這份文件提供了 Bug 119 任務狀態管理系統的完整分析與設計方案，可作為開發團隊的重要參考文件。